// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Mehdi Hesami (hesami13@yahoo.com)

//@version=5 
indicator("Advanced Scalping EMA & RSI Strategy", overlay=true)

// بخش تنظیمات EMA سریع‌تر (Quick EMA)
group_fastEma = "Quick EMA Settings"
fastEmaSource = input.source(ohlc4, title="Source", group=group_fastEma, tooltip = "The data source used for calculating the quick EMA. Options include open, high, low, close, and typical price (OHLC4).") // تغییر به OHLC4
fastEmaLength = input.int(9, title="Length", group=group_fastEma, tooltip = "The number of periods used to calculate the quick EMA. Shorter periods result in a more reactive EMA.")
fastEmaMethod = input.string("VWMA", title="Method", options=["SMA", "EMA", "WMA", "VWMA"], group=group_fastEma, tooltip = "The method used to calculate the moving average. Options include Simple Moving Average (SMA), Exponential Moving Average (EMA), Weighted Moving Average (WMA), and Volume Weighted Moving Average1 (VWMA).") // پیش‌فرض به VWMA

// تابع انتخاب متد برای EMA سریع‌تر
fastEma = switch fastEmaMethod
    "SMA" => ta.sma(fastEmaSource, fastEmaLength)
    "EMA" => ta.ema(fastEmaSource, fastEmaLength)
    "WMA" => ta.wma(fastEmaSource, fastEmaLength)
    "VWMA" => ta.vwma(fastEmaSource, fastEmaLength)

// بخش تنظیمات EMA نرم‌تر (Smooth EMA)
group_smoothEma = "Smooth EMA Settings"
smoothEmaSource = input.source(ohlc4, title="Source", group=group_smoothEma) // تغییر به OHLC4
smoothEmaLength = input.int(21, title="Length", group=group_smoothEma, tooltip = "Similar to the quick EMA settings, but with a longer default length for a smoother moving average.")
smoothEmaMethod = input.string("VWMA", title="Method", options=["SMA", "EMA", "WMA", "VWMA"], group=group_smoothEma) // پیش‌فرض به VWMA

// تابع انتخاب متد برای EMA نرم‌تر
smoothEma = switch smoothEmaMethod
    "SMA" => ta.sma(smoothEmaSource, smoothEmaLength)
    "EMA" => ta.ema(smoothEmaSource, smoothEmaLength)
    "WMA" => ta.wma(smoothEmaSource, smoothEmaLength)
    "VWMA" => ta.vwma(smoothEmaSource, smoothEmaLength)

// بخش تنظیمات RSI
group_rsi = "RSI Settings"
rsiLength = input.int(14, title="RSI Length", group=group_rsi, tooltip = "The number of periods used in the RSI calculation.")
rsiSource = input.source(close, title="RSI Source", group=group_rsi, tooltip = "The price data used to calculate the RSI.")
rsiOverbought = input.int(70, title="RSI Overbought Level", minval=40, maxval=100, group=group_rsi, tooltip = "The levels at which the market is considered overbought.")
rsiOverboughtBuffer = input.int(60, title="RSI Overbought Buffer Level", minval=40, maxval=100, group=group_rsi, tooltip = "Additional buffers to provide more flexibility in defining overbought conditions.")  // سطح بافر برای انعطاف
rsiOversold = input.int(30, title="RSI Oversold Level", minval=0, maxval=50, group=group_rsi, tooltip = "The levels at which the market is considered oversold.")
rsiOversoldBuffer = input.int(40, title="RSI Oversold Buffer Level", minval=0, maxval=50, group=group_rsi, tooltip = "Additional buffers to provide more flexibility in defining oversold conditions.")  // سطح بافر برای انعطاف

// محاسبه RSI دو کندل قبلی
rsi = ta.rsi(rsiSource, rsiLength)
rsiLag = ta.rsi(rsiSource, rsiLength)[2]  // بررسی RSI دو کندل قبل

// بخش تنظیمات Scalping (استفاده از ATR به عنوان فیلتر)
group_scalping = "Scalping Settings"
useAtrFilter = input.bool(true, title="Use ATR Filter for Scalping", group=group_scalping, tooltip = "Enables or disables the ATR filter for scalping trades.")
atrLength = input.int(14, title="ATR Length", group=group_scalping, tooltip = "The number of periods used to calculate the Average True Range (ATR).")
atrMultiplier = input.float(0.35, title="ATR Multiplier", group=group_scalping, tooltip = "A multiplier applied to the ATR to determine the minimum price movement required for a trade.")
atrAdaptive = input.bool(true, title="Adaptive ATR Multiplier", group=group_scalping, tooltip = "Enables a dynamic ATR multiplier based on the current volatility of the market.")

// محاسبه ATR
atr = ta.atr(atrLength)

// تغییر دادن ATR multiplier در صورت فعال بودن Adaptive ATR
multiplier = useAtrFilter and atrAdaptive ? atrMultiplier * (atr / ta.ema(atr, atrLength)) : atrMultiplier

// محاسبه روند (صعودی یا نزولی)
trendCondition = fastEma > smoothEma ? "Bullish" : "Bearish"

// قوانین ورود Long
longCondition = ta.crossover(fastEma, smoothEma) and close > fastEma and (rsi < rsiOversold or rsiLag < rsiOversoldBuffer)

// قوانین ورود Short
shortCondition = ta.crossunder(fastEma, smoothEma) and close < fastEma and (rsi > rsiOverbought or rsiLag > rsiOverboughtBuffer)

// اعمال فیلتر ATR برای معاملات اسکالپی
if useAtrFilter
    longCondition := longCondition and close - fastEma > atr * multiplier
    shortCondition := shortCondition and fastEma - close > atr * multiplier


// بخش جدید بررسی تایید کندل (الگوریتم جدید)
checkCandleConfirmation = input.bool(true, title="Candle Stick Confirmation",tooltip = "Verifying trading signals using candlestick patterns (e.g., BodySize, trend, etc.).", group="Additional Settings")

// دوره زمانی برای محاسبه میانگین اندازه بدنه کندل (مثلاً 10 کندل)
avgBodySizelength = 12

// محاسبه میانگین اندازه بدنه کندل
avgBodySize = ta.ema(math.abs(close - open), avgBodySizelength)

// آستانه حداقل اندازه بدنه کندل (مثلاً 50% میانگین اندازه بدنه)
minBodySize = 0.5 * avgBodySize

// الگوریتم تایید کندل برای سیگنال Buy
bullishCandleConfirmation = (close > open) and (close - open > minBodySize) or ((close > close[1]) and (close[1] > open[1]) and (close - close[1] > minBodySize)) or ((close < open) and (close > close[2]) and (close[2] > open[2]) and (close - close[2] > minBodySize))

// الگوریتم تایید کندل برای سیگنال Sell
bearishCandleConfirmation = (close < open) and (open - close > minBodySize) or ((close < close[1]) and (close[1] < open[1]) and (close[1] - close > minBodySize)) or ((close > open) and (close < close[2]) and (close[2] < open[2]) and (close[2] - close > minBodySize))

// افزودن شرط تایید کندل در صورت فعال بودن
if checkCandleConfirmation
    longCondition := longCondition and bullishCandleConfirmation
    shortCondition := shortCondition and bearishCandleConfirmation

// نمایش سیگنال Buy
plotshape(series=longCondition, title="Buy Signal", location=location.belowbar, color=#34ba3f, textcolor=color.white, style=shape.labelup, text="Buy")

// نمایش سیگنال Sell
plotshape(series=shortCondition, title="Sell Signal", location=location.abovebar, color=#ef3345, textcolor=color.white, style=shape.labeldown, text="Sell")

// نمایش EMAها
plot(fastEma, title="Quick EMA", color=#03cf62, linewidth=2)
plot(smoothEma, title="Smooth EMA", color=#ff0450, linewidth=2)


// نمایش وضعیت روند فعلی
// cloudTop = ta.highest(high, 30)
// cloudBottom = ta.lowest(low, 30)
// cloudColor = trendCondition == "Bullish" ? color.green : color.red
// plot(cloudTop, title = "Top Trend", color=cloudColor, linewidth = 2, style=plot.style_linebr)
// plot(cloudBottom, title = "Bottom Trend", color=cloudColor, linewidth = 2, style=plot.style_linebr)
